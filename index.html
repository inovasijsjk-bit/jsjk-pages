<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CCID ChatBot</title>
  <style>
    :root{
      --bg:#070b16;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --accent:rgba(59,130,246,.95);
      --good:rgba(34,197,94,.95);
      --danger:rgba(239,68,68,.95);
      color-scheme: dark;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(900px 520px at 20% 0%, rgba(59,130,246,.28), transparent 55%),
        radial-gradient(900px 520px at 100% 10%, rgba(34,197,94,.16), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    .app{height:100%;display:flex;flex-direction:column;align-items:center;}
    .shell{
      width:min(980px, 100%);
      height:100%;
      display:flex;
      flex-direction:column;
      padding: clamp(10px, 2.5vw, 16px);
      gap:10px;
    }
    header{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:1px solid var(--stroke);
      background:linear-gradient(90deg, rgba(59,130,246,.18), rgba(34,197,94,.10));
      border-radius:18px;padding:12px 14px;
    }
    .brand{display:flex;gap:10px;align-items:center;min-width:0;}
    .logo{
      width:36px;height:36px;border-radius:12px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      display:grid;place-items:center;flex:0 0 auto;
    }
    .titleWrap{min-width:0;}
    .title{font-size:14px;margin:0;font-weight:700;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .subtitle{margin:2px 0 0;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .statusPill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--stroke);background:rgba(0,0,0,.18);
      padding:7px 10px;border-radius:999px;font-size:12px;color:var(--muted);flex:0 0 auto;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.35);}
    .dot.ok{background:rgba(34,197,94,.95);}
    .dot.bad{background:rgba(239,68,68,.95);}

    .chat{
      flex:1 1 auto;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      border-radius:18px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .messages{flex:1 1 auto;padding:14px;overflow:auto;scroll-behavior:smooth;}
    .row{display:flex;gap:10px;margin:10px 0;align-items:flex-start;}
    .row.user{justify-content:flex-end;}
    .bubble{
      max-width:min(680px, 92%);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px 12px;
      line-height:1.45;
      font-size:14px;
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    .row.user .bubble{background:rgba(59,130,246,.18);border-color:rgba(59,130,246,.22);}
    .meta{font-size:11px;color:var(--muted);margin-top:6px;}
    .quick{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
    .btn{
      appearance:none;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);color:var(--text);
      padding:9px 10px;border-radius:12px;font-size:13px;cursor:pointer;
      transition:transform .04s ease, background .15s ease;user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,.09);}
    .btn:active{transform:translateY(1px);}
    .btn.primary{background:rgba(34,197,94,.14); border-color:rgba(34,197,94,.22);}
    .btn.blue{background:rgba(59,130,246,.14); border-color:rgba(59,130,246,.22);}
    .btn.danger{background:rgba(239,68,68,.14); border-color:rgba(239,68,68,.22);}

    .composer{
      border-top:1px solid rgba(255,255,255,.10);
      padding:10px;background:rgba(0,0,0,.14);
      display:flex;gap:10px;align-items:center;
    }
    .input{
      flex:1 1 auto;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);color:var(--text);
      padding:12px 12px;border-radius:14px;outline:none;font-size:14px;min-width:0;
    }
    .send{
      flex:0 0 auto;border-radius:14px;padding:12px 14px;
      border:1px solid rgba(59,130,246,.22);
      background:rgba(59,130,246,.18);
      color:var(--text);cursor:pointer;font-weight:650;font-size:14px;
    }
    .send:active{transform:translateY(1px);}

    @media (max-width:520px){
      header{padding:10px 12px;border-radius:16px;}
      .logo{width:34px;height:34px;border-radius:12px;}
      .messages{padding:12px;}
      .bubble{font-size:14px; max-width: 94%;}
      .composer{padding:10px; gap:8px;}
      .send{padding:12px 12px;}
      .statusPill{display:none;}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="shell">
      <header>
        <div class="brand">
          <div class="logo">üõ°Ô∏è</div>
          <div class="titleWrap">
            <div class="title">CCID ChatBot</div>
            <div class="subtitle" id="subTitle">JSJK ‚Ä¢ Anti-Scam Assistance</div>
          </div>
        </div>
        <div class="statusPill">
          <span class="dot" id="dot"></span>
          <span id="netText">Connecting‚Ä¶</span>
        </div>
      </header>

      <section class="chat">
        <div class="messages" id="messages"></div>

        <div class="composer">
          <input class="input" id="input" placeholder="Taip mesej‚Ä¶" autocomplete="off" />
          <button class="send" id="send">Hantar</button>
        </div>
      </section>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const API_BASE = "https://ccid-scambot-api.ccid-scambot.workers.dev";

    // Typing speed (kecil = laju)
    let TYPE_DELAY_MS = 12;
    let AFTER_MESSAGE_PAUSE_MS = 220;

    // =========================
    // STATE
    // =========================
    const State = {
      ASK_NAME: "ASK_NAME",
      MAIN_MENU: "MAIN_MENU",
      MODE_MENU: "MODE_MENU",
      ACTION_MENU: "ACTION_MENU",
      REPORT_MENU: "REPORT_MENU",
      CHECK_MENU: "CHECK_MENU",
    };

    let state = State.ASK_NAME;
    let userName = "";
    let lang = "ms";

    // ‚úÖ Dynamic lists from DB
    let MODUS_CHOICES = [];   // [{code,label}]
    let ACTION_CHOICES = [];  // [{code,label}]

    // =========================
    // DOM
    // =========================
    const elMessages = document.getElementById("messages");
    const elInput = document.getElementById("input");
    const elSend = document.getElementById("send");
    const elDot = document.getElementById("dot");
    const elNetText = document.getElementById("netText");

    // =========================
    // HELPERS
    // =========================
    function scrollToBottom() {
      elMessages.scrollTop = elMessages.scrollHeight;
    }

    function addBubble(text, who="bot", quickButtons=[]) {
      const row = document.createElement("div");
      row.className = "row " + (who === "user" ? "user" : "bot");

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;

      row.appendChild(bubble);
      elMessages.appendChild(row);

      if (quickButtons && quickButtons.length) {
        const quick = document.createElement("div");
        quick.className = "quick";
        for (const b of quickButtons) {
          const btn = document.createElement("button");
          btn.className = "btn " + (b.variant || "");
          btn.textContent = b.text;
          btn.onclick = () => handleUserInput(b.value, true);
          quick.appendChild(btn);
        }
        bubble.appendChild(document.createElement("div")).className = "meta";
        bubble.appendChild(quick);
      }

      scrollToBottom();
      return bubble;
    }

    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    async function typeBotMessage(text, quickButtons=[]) {
      const row = document.createElement("div");
      row.className = "row bot";
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      row.appendChild(bubble);
      elMessages.appendChild(row);
      scrollToBottom();

      for (let i = 0; i < text.length; i++) {
        bubble.textContent += text[i];
        if (i % 3 === 0) scrollToBottom();
        await sleep(TYPE_DELAY_MS);
      }
      scrollToBottom();

      if (quickButtons && quickButtons.length) {
        const quick = document.createElement("div");
        quick.className = "quick";
        for (const b of quickButtons) {
          const btn = document.createElement("button");
          btn.className = "btn " + (b.variant || "");
          btn.textContent = b.text;
          btn.onclick = () => handleUserInput(b.value, true);
          quick.appendChild(btn);
        }
        bubble.appendChild(document.createElement("div")).className = "meta";
        bubble.appendChild(quick);
      }

      await sleep(AFTER_MESSAGE_PAUSE_MS);
    }

    function detectLanguageSimple(text) {
      const t = (text || "").trim();
      const englishHints = /\b(hi|hello|help|menu|option|report|scam|bank|police|investment|transfer)\b/i;
      if (englishHints.test(t)) return "en";
      return "ms";
    }

    function setNetwork(ok) {
      elDot.classList.remove("ok","bad");
      elDot.classList.add(ok ? "ok" : "bad");
      elNetText.textContent = ok ? "Online" : "Offline";
    }

    async function ping() {
      try {
        const r = await fetch(API_BASE + "/", { method:"GET" });
        setNetwork(r.ok);
      } catch {
        setNetwork(false);
      }
    }

    async function callChatAPI(message) {
      const payload = { message, lang };
      const res = await fetch(API_BASE + "/api/chat", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload),
      });
      const data = await res.json().catch(()=>null);
      if (!res.ok || !data?.ok) throw new Error(data?.error || ("HTTP " + res.status));
      return data;
    }

    async function loadPublicLists() {
      // load modus & actions based on current lang
      const m = await fetch(API_BASE + "/api/public/modus/list?lang=" + encodeURIComponent(lang)).then(r=>r.json());
      const a = await fetch(API_BASE + "/api/public/actions/list?lang=" + encodeURIComponent(lang)).then(r=>r.json());

      MODUS_CHOICES = Array.isArray(m?.items) ? m.items : [];
      ACTION_CHOICES = Array.isArray(a?.items) ? a.items : [];

      // fallback if empty
      if (!MODUS_CHOICES.length) MODUS_CHOICES = [{ code:"PHONE_SCAM", label: lang==="en"?"Phone Scam":"Phone Scam" }];
      if (!ACTION_CHOICES.length) ACTION_CHOICES = [{ code:"A", label: lang==="en"?"Suspicious call":"Panggilan mencurigakan" }];
    }

    // =========================
    // FLOWS
    // =========================
    async function showGreeting() {
      await typeBotMessage(
        "Hai, Selamat Sejahtera! Saya CCID ChatBot, Pegawai JSJK yang akan membantu anda.\n\nBoleh saya tahu nama anda?"
      );
      state = State.ASK_NAME;
      elInput.placeholder = "Taip nama anda‚Ä¶";
    }

    async function showMainMenu() {
      state = State.MAIN_MENU;
      elInput.placeholder = "Taip 1 / 2 / 3 / 4 atau pilih butang‚Ä¶";

      const ms = `Hai ${userName}! Apa yang saya boleh bantu anda hari ini?\n\nPilih 1 daripada 4 menu berikut:\n1) Membuat Semakan No. Telefon / No. Akaun Bank\n2) Pertanyaan Berkaitan Modus Operandi\n3) Tindakan Yang Perlu Diambil Jika Kena Scam\n4) Cara Melaporkan`;
      const en = `Hi ${userName}! How can I help you today?\n\nChoose 1 of these 4 menus:\n1) Check phone number / bank account\n2) Scam modus operandi info\n3) What to do if you got scammed\n4) How to report`;

      await typeBotMessage(lang === "en" ? en : ms, [
        { text: lang==="en" ? "1) Check" : "1) Semakan", value: "1", variant:"blue" },
        { text: lang==="en" ? "2) Modus" : "2) Modus", value: "2", variant:"blue" },
        { text: lang==="en" ? "3) Actions" : "3) Tindakan", value: "3", variant:"blue" },
        { text: lang==="en" ? "4) Report" : "4) Laporan", value: "4", variant:"blue" },
      ]);
    }

    async function showModusMenu() {
      state = State.MODE_MENU;
      elInput.placeholder = lang === "en" ? "Type modus number or 'none'‚Ä¶" : "Taip nombor modus atau 'tiada'‚Ä¶";

      // refresh lists for current lang
      await loadPublicLists();

      const introMS = "Baik. Apakah modus operandi yang anda mahu tahu? Sila pilih salah satu:";
      const introEN = "Alright. Which modus operandi would you like to know? Please choose one:";

      const buttons = MODUS_CHOICES.map((m, i) => ({
        text: (i+1) + ") " + (m.label || m.code),
        value: String(i+1),
      }));
      buttons.push({ text: lang === "en" ? "None (Stop)" : "Tiada (Tamat)", value: "tiada", variant:"danger" });

      await typeBotMessage(lang === "en" ? introEN : introMS, buttons);
    }

    async function showActionMenu() {
      state = State.ACTION_MENU;
      elInput.placeholder = lang === "en" ? "Type action number (or code)‚Ä¶" : "Taip nombor tindakan (atau code)‚Ä¶";

      // refresh lists for current lang
      await loadPublicLists();

      const ms = "Baik. Sila pilih situasi anda:";
      const en = "Alright. Please choose your situation:";

      const buttons = ACTION_CHOICES.map((a, i) => ({
        text: (i+1) + ") " + (a.label || a.code),
        value: String(i+1),
      }));

      await typeBotMessage(lang === "en" ? en : ms, buttons);
    }

    async function showReportMenu() {
      state = State.REPORT_MENU;
      elInput.placeholder = lang === "en" ? "Type 'menu' to return‚Ä¶" : "Taip 'menu' untuk kembali‚Ä¶";

      const ms =
`Tindakan pantas:
‚Ä¢ Hubungi National Scam Response Center (NSRC) di talian 997 (segera).
‚Ä¢ Buat laporan polis di balai polis berhampiran.

Cadangan:
‚Ä¢ Simpan bukti: resit transaksi, screenshot chat, nombor telefon, nama akaun, URL, dan masa kejadian.
‚Ä¢ Jika melibatkan perbankan, hubungi bank untuk sekat transaksi secepat mungkin.

Taip "menu" untuk kembali ke menu utama.`;
      const en =
`Immediate actions:
‚Ä¢ Call National Scam Response Center (NSRC) at 997 (as soon as possible).
‚Ä¢ Lodge a police report at the nearest station.

Tips:
‚Ä¢ Keep evidence: receipts, screenshots, phone numbers, account names, URLs, and timestamps.
‚Ä¢ If banking is involved, call your bank to block transactions ASAP.

Type "menu" to return to the main menu.`;

      await typeBotMessage(lang === "en" ? en : ms, [
        { text: lang === "en" ? "Back to Menu" : "Kembali Menu", value: "menu", variant:"blue" }
      ]);
    }

    async function showCheckMenu() {
      state = State.CHECK_MENU;
      elInput.placeholder = lang === "en" ? "Type phone/account number (or 'menu')‚Ä¶" : "Taip no telefon / no akaun (atau 'menu')‚Ä¶";

      const ms =
`Baik. Untuk semakan:
‚Ä¢ Anda boleh semak melalui portal rasmi Semak Mule (PDRM): https://semakmule.rmp.gov.my/

Sila masukkan No. Telefon / No. Akaun Bank untuk saya bantu format semakan (atau taip "menu" untuk kembali).`;
      const en =
`Alright. For checking:
‚Ä¢ You may check via the official Semak Mule (PDRM) portal: https://semakmule.rmp.gov.my/

Please enter the phone/bank account number (or type "menu" to return).`;

      await typeBotMessage(lang === "en" ? en : ms, [
        { text: lang === "en" ? "Back to Menu" : "Kembali Menu", value: "menu", variant:"blue" }
      ]);
    }

    async function afterModusAnswered(lastLabel) {
      const ms =
`Sekian maklumat berkenaan modus operandi: ${lastLabel}.
Adakah anda mahu bertanya berkenaan modus operandi lain?

Sila pilih pilihan berikut:`;
      const en =
`That‚Äôs the information for: ${lastLabel}.
Would you like to ask about another modus?

Please choose:`;

      await loadPublicLists();
      const buttons = MODUS_CHOICES.map((m, i) => ({
        text: (i+1) + ") " + (m.label || m.code),
        value: String(i+1),
      }));
      buttons.push({ text: lang === "en" ? "None (Stop)" : "Tiada", value:"tiada", variant:"danger" });

      await typeBotMessage(lang === "en" ? en : ms, buttons);
      state = State.MODE_MENU;
    }

    async function endConversation() {
      const ms = "Terima kasih. Kami harap ianya membantu.\n\nBe Smart, Stay Alert.";
      const en = "Thank you. We hope this helps.\n\nBe Smart, Stay Alert.";
      await typeBotMessage(lang === "en" ? en : ms, [
        { text: lang === "en" ? "Start Again" : "Mula Semula", value: "restart", variant:"primary" },
        { text: lang === "en" ? "Main Menu" : "Menu Utama", value: "menu", variant:"blue" }
      ]);
      state = State.MAIN_MENU;
    }

    // =========================
    // INPUT HANDLER
    // =========================
    async function handleUserInput(raw, fromButton=false) {
      const text = String(raw || "").trim();
      if (!text) return;

      if (!fromButton) {
        lang = detectLanguageSimple(text);
      }

      addBubble(text, "user");
      elInput.value = "";

      const lower = text.toLowerCase();
      if (lower === "restart") {
        userName = "";
        lang = "ms";
        state = State.ASK_NAME;
        await showGreeting();
        return;
      }
      if (lower === "menu") {
        if (!userName) await showGreeting();
        else await showMainMenu();
        return;
      }

      if (state === State.ASK_NAME) {
        userName = text.replace(/^nama saya\s+/i,"").slice(0, 40) || "Pengguna";
        await showMainMenu();
        return;
      }

      if (state === State.MAIN_MENU) {
        const choice = (text.match(/^[1-4]$/) ? text : null);
        if (!choice) {
          await typeBotMessage(lang === "en" ? "Please choose 1, 2, 3 or 4 (or tap a button)." : "Sila pilih 1, 2, 3 atau 4 (atau tekan butang).");
          return;
        }
        if (choice === "1") return showCheckMenu();
        if (choice === "2") return showModusMenu();
        if (choice === "3") return showActionMenu();
        if (choice === "4") return showReportMenu();
      }

      if (state === State.MODE_MENU) {
        if (lower === "tiada" || lower === "none" || lower === "0") {
          await endConversation();
          return;
        }

        await loadPublicLists();
        const idx = Number(text) - 1;
        if (Number.isFinite(idx) && idx >= 0 && idx < MODUS_CHOICES.length) {
          const selected = MODUS_CHOICES[idx];
          try {
            const resp = await callChatAPI(selected.code);
            const msg = resp?.reply?.message || (lang === "en" ? "No info found." : "Maklumat tidak dijumpai.");
            await typeBotMessage(msg);
            await afterModusAnswered(selected.label || selected.code);
          } catch (e) {
            await typeBotMessage((lang === "en" ? "Server error: " : "Ralat server: ") + e.message);
          }
          return;
        }

        await typeBotMessage(lang === "en" ? "Please select a valid number, or type 'none'." : "Sila pilih nombor yang betul, atau taip 'tiada'.");
        return;
      }

      if (state === State.ACTION_MENU) {
        await loadPublicLists();

        // User can type number OR actual action code
        let selected = null;
        const idx = Number(text) - 1;
        if (Number.isFinite(idx) && idx >= 0 && idx < ACTION_CHOICES.length) selected = ACTION_CHOICES[idx];

        if (!selected) {
          const codeTry = text.trim().toUpperCase();
          selected = ACTION_CHOICES.find(a => String(a.code).toUpperCase() === codeTry);
        }

        if (!selected) {
          await typeBotMessage(lang === "en" ? "Please choose a valid action." : "Sila pilih tindakan yang betul.");
          return;
        }

        try {
          const resp = await callChatAPI(selected.code);
          const msg = resp?.reply?.message || (lang === "en" ? "No info found." : "Maklumat tidak dijumpai.");
          await typeBotMessage(msg, [
            { text: lang === "en" ? "Back to Menu" : "Kembali Menu", value: "menu", variant:"blue" },
            { text: lang === "en" ? "Report" : "Cara Lapor", value: "4", variant:"" },
          ]);
          state = State.MAIN_MENU;
        } catch (e) {
          await typeBotMessage((lang === "en" ? "Server error: " : "Ralat server: ") + e.message);
        }
        return;
      }

      if (state === State.CHECK_MENU) {
        if (lower === "menu") return showMainMenu();

        const ms =
`Saya tidak boleh semak terus dalam sistem bank, tetapi saya boleh bantu anda:
‚Ä¢ Semak nombor ini di portal rasmi Semak Mule: https://semakmule.rmp.gov.my/
‚Ä¢ Simpan bukti (screenshot/resit) jika ada.

No yang anda masukkan: ${text}

Taip "menu" untuk kembali.`;
        const en =
`I cannot check bank systems directly, but you can:
‚Ä¢ Check via the official Semak Mule portal: https://semakmule.rmp.gov.my/
‚Ä¢ Keep evidence (screenshots/receipts).

You entered: ${text}

Type "menu" to return.`;

        await typeBotMessage(lang === "en" ? en : ms);
        return;
      }

      await typeBotMessage(lang === "en" ? "Type 'menu' to continue." : "Taip 'menu' untuk teruskan.");
    }

    // =========================
    // EVENTS
    // =========================
    elSend.addEventListener("click", () => handleUserInput(elInput.value));
    elInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") handleUserInput(elInput.value);
    });

    // =========================
    // INIT
    // =========================
    (async function init(){
      await ping();
      await loadPublicLists(); // preload
      await showGreeting();
    })();
  </script>
</body>
</html>
