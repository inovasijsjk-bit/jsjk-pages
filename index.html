<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CCID ScamBOT</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 0; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 18px; }
    .card { border: 1px solid rgba(127,127,127,.25); border-radius: 14px; padding: 14px; }
    h1 { margin: 0 0 6px; font-size: 20px; }
    .sub { opacity: .75; margin: 0 0 12px; font-size: 13px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    #chat { height: 55vh; overflow: auto; border: 1px solid rgba(127,127,127,.25); border-radius: 12px; padding: 12px; background: rgba(127,127,127,.06); }
    .msg { max-width: 85%; padding: 10px 12px; border-radius: 12px; margin: 8px 0; white-space: pre-wrap; word-break: break-word; }
    .user { margin-left: auto; background: rgba(0, 128, 255, .18); border: 1px solid rgba(0, 128, 255, .25); }
    .bot { margin-right: auto; background: rgba(0, 200, 120, .15); border: 1px solid rgba(0, 200, 120, .22); }
    .meta { margin-top: 6px; font-size: 12px; opacity: .7; }
    .controls { margin-top: 12px; }
    input[type="text"] { flex: 1; min-width: 240px; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(127,127,127,.35); }
    button { padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(127,127,127,.35); cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .small { font-size: 12px; opacity: .75; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
    .pill { display: inline-block; padding: 4px 8px; border: 1px solid rgba(127,127,127,.35); border-radius: 999px; font-size: 12px; opacity: .85; }
    .hint { margin-top: 10px; padding: 10px 12px; border-radius: 12px; border: 1px dashed rgba(127,127,127,.45); opacity: .9; }
    .quick { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .qbtn { padding: 8px 10px; border-radius: 999px; font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>CCID ScamBOT</h1>
      <p class="sub">
        Status API: <span id="status" class="pill">-</span>
        &nbsp;â€¢&nbsp; Origin: <code id="origin">-</code>
      </p>

      <div id="chat" aria-live="polite"></div>

      <div class="controls">
        <div class="row">
          <input id="msg" type="text" placeholder="Taip mesej... (contoh: Tolong semak 012-3456789)" autocomplete="off" />
          <button id="send">Send</button>
          <button id="quickCheck" title="Semak nombor/akaun secara terus">Quick Check</button>
        </div>

        <!-- Quick actions untuk pengguna awam (lebih mesra panik/urgent) -->
        <div class="quick" aria-label="Quick actions">
          <button class="qbtn" data-fill="Dia minta OTP/TAC sekarang. Apa perlu saya buat?">ðŸš¨ Saya sedang dihubungi</button>
          <button class="qbtn" data-fill="Saya dah buat bayaran/transfer. Apa langkah seterusnya?">ðŸ’¸ Saya dah transfer</button>
          <button class="qbtn" data-fill="Tolong terangkan tanda-tanda Phone Scam.">ðŸ“ž Phone Scam</button>
          <button class="qbtn" data-fill="Tolong terangkan tanda-tanda Tipu Pelaburan.">ðŸ“ˆ Pelaburan</button>
          <button class="qbtn" data-fill="Tolong terangkan tanda-tanda Phishing.">ðŸ”— Phishing</button>
          <button class="qbtn" data-fill="Macam mana nak buat laporan rasmi?">ðŸ§¾ Cara laporan</button>
        </div>

        <div class="hint" id="hint" style="display:none;"></div>
        <div class="small" style="margin-top:8px;">
          Tip: tekan <b>Enter</b> untuk hantar.
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // API BASE
    // =========================
    // Anda boleh kekalkan URL Worker anda di sini.
    // Jika suatu hari UI di-serve dari domain Worker yang sama, anda boleh guna relatif: const API_BASE = window.location.origin;
    const API_BASE = "https://ccid-scambot-api.ccid-scambot.workers.dev";

    const ORIGIN = window.location.origin;
    document.getElementById("origin").textContent = ORIGIN;

    const chatEl = document.getElementById("chat");
    const statusEl = document.getElementById("status");
    const hintEl = document.getElementById("hint");
    const sendBtn = document.getElementById("send");
    const quickBtn = document.getElementById("quickCheck");
    const msgInput = document.getElementById("msg");

    function addMsg(text, who, meta = "") {
      const wrap = document.createElement("div");
      wrap.className = "msg " + who;
      wrap.textContent = text;

      if (meta) {
        const m = document.createElement("div");
        m.className = "meta";
        m.textContent = meta;
        wrap.appendChild(m);
      }

      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setHint(text) {
      if (!text) {
        hintEl.style.display = "none";
        hintEl.textContent = "";
        return;
      }
      hintEl.style.display = "block";
      hintEl.textContent = text;
    }

    function setBusy(isBusy) {
      sendBtn.disabled = isBusy;
      quickBtn.disabled = isBusy;
      msgInput.disabled = isBusy;
    }

    async function healthCheck() {
      try {
        const res = await fetch(API_BASE + "/", { method: "GET" });
        const txt = await res.text();
        let data = null;
        try { data = JSON.parse(txt); } catch {}

        if (res.ok && data && data.ok) statusEl.textContent = "OK âœ…";
        else if (res.ok) statusEl.textContent = "Reachable âœ…";
        else statusEl.textContent = `Err ${res.status} âŒ`;
      } catch (e) {
        statusEl.textContent = "Failed âŒ";
      }
    }

    async function postJson(url, payload) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const text = await res.text();
      if (!res.ok) throw new Error(`API ${res.status}: ${text.slice(0, 250)}`);

      try { return JSON.parse(text); }
      catch { throw new Error(`Response bukan JSON: ${text.slice(0, 250)}`); }
    }

    async function sendChat(message) {
      setHint("");
      addMsg(message, "user");
      setBusy(true);

      try {
        const data = await postJson(API_BASE + "/api/chat", { message });

        const meta = [
          data.lang ? `lang=${data.lang}` : null,
          data.intent ? `intent=${data.intent}` : null,
          data.risk_level ? `risk=${data.risk_level}` : null,
          (typeof data.risk_score === "number") ? `score=${data.risk_score}` : null,
        ].filter(Boolean).join(" | ");

        addMsg(data.reply?.message || "(tiada jawapan)", "bot", meta);

        if (data.slots && data.slots.number_last4) {
          setHint(`Saya kesan nombor berakhir dengan ****${data.slots.number_last4}. Anda juga boleh guna Quick Check untuk semakan langkah rasmi.`);
        } else {
          setHint("");
        }
      } catch (e) {
        addMsg(`Ralat: ${e.message || e}`, "bot");
        setHint("Semak domain API_BASE, CORS, dan pastikan endpoint /api/chat wujud.");
      } finally {
        setBusy(false);
        msgInput.focus();
      }
    }

    async function quickCheckNumber() {
      setHint("");
      const value = msgInput.value.trim();

      if (!value) {
        alert("Sila masukkan nombor telefon atau akaun bank.");
        return;
      }

      addMsg("Semakan nombor: " + value, "user");
      setBusy(true);

      try {
        const data = await postJson(API_BASE + "/api/check", { value, lang: "BM" });

        if (!data.ok) {
          addMsg("Semakan gagal. Sila cuba lagi.", "bot");
          return;
        }

        const reply =
          `ðŸ”Ž Keputusan Semakan Rasmi\n` +
          `Jenis: ${data.number_type}\n` +
          `Nombor: ${data.masked}\n\n` +
          `Portal: ${data.official_check?.name || "-"}\n` +
          `${data.official_check?.url || "-"}\n\n` +
          `Langkah:\n- ${(data.official_check?.steps || []).join("\n- ")}\n\n` +
          `Nota: Semakan rasmi perlu dibuat di portal (bot tidak mengesahkan muktamad).`;

        addMsg(reply, "bot");
        msgInput.value = "";
      } catch (e) {
        addMsg(`Ralat semakan: ${e.message || e}`, "bot");
        setHint("Jika ini berlaku, semak log Worker (wrangler tail) dan rate limit.");
      } finally {
        setBusy(false);
        msgInput.focus();
      }
    }

    // Event listeners
    sendBtn.addEventListener("click", () => {
      const text = msgInput.value.trim();
      if (!text) return;
      msgInput.value = "";
      sendChat(text);
    });

    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    quickBtn.addEventListener("click", quickCheckNumber);

    // Quick action buttons
    document.querySelectorAll("[data-fill]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const fill = btn.getAttribute("data-fill") || "";
        msgInput.value = fill;
        msgInput.focus();
      });
    });

    // init
    healthCheck();
    addMsg(
      "Hai! Saya CCID ScamBOT. Taip situasi anda atau nombor untuk semakan (contoh: Tolong semak 012-3456789).",
      "bot"
    );
  </script>
</body>
</html>
